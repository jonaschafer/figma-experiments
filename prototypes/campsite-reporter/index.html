<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PDX Campsite Reporter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #1a472a;
            color: white;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .user-message {
            background: #1a472a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .input-area {
            background: white;
            padding: 12px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
        }

        .input-area input:focus {
            border-color: #1a472a;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-button {
            background: #1a472a;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .quick-button:active {
            background: #143820;
        }

        .send-button {
            background: #1a472a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .send-button:active {
            background: #143820;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .voice-button {
            background: #f0f0f0;
            border: none;
            padding: 12px;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 20px;
        }

        .voice-button.recording {
            background: #ff4444;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 60px;
            align-self: flex-start;
            position: absolute;
            bottom: 80px;
            left: 20px;
        }

        .typing-indicator.active {
            display: block;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .submit-form-button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }

        .location-help {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .restart-button {
            background: #f0f0f0;
            color: #666;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        PDX Campsite Reporter
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            Hi! I'll help you report a campsite to the City of Portland. This will take about 60 seconds. Ready to start?
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Type your answer..." />
        <button class="voice-button" id="voiceButton" title="Voice input">ðŸŽ¤</button>
        <button class="send-button" id="sendButton">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const voiceButton = document.getElementById('voiceButton');
        const typingIndicator = document.getElementById('typingIndicator');

        let conversationState = {
            step: 0,
            data: {
                location: '',
                tentCount: '',
                vehicles: '',
                description: '',
                timeline: '',
                contact: ''
            }
        };

        const questions = [
            {
                question: "Where is the campsite located? (You can say the address, intersection, or nearby landmark)",
                key: 'location',
                help: "e.g., 'SE Hawthorne and 32nd' or '123 Main St'"
            },
            {
                question: "How many tents or structures do you see?",
                key: 'tentCount',
                options: ['1-2', '3-5', '6-10', 'More than 10', 'Not sure']
            },
            {
                question: "Are there any vehicles? (cars, RVs, trailers)",
                key: 'vehicles',
                options: ['No vehicles', '1-2 vehicles', '3+ vehicles']
            },
            {
                question: "When did you first notice this campsite?",
                key: 'timeline',
                options: ['Today', 'This week', 'This month', 'Longer than a month']
            },
            {
                question: "Anything else you'd like to add? (optional - describe conditions, concerns, etc.)",
                key: 'description',
                optional: true
            },
            {
                question: "Would you like to provide your email for follow-up? (optional)",
                key: 'contact',
                optional: true
            }
        ];

        function addMessage(text, isUser = false) {
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            message.textContent = text;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            typingIndicator.classList.add('active');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.classList.remove('active');
        }

        function addButtons(options) {
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'quick-button';
                button.textContent = option;
                button.onclick = () => handleUserResponse(option);
                buttonGroup.appendChild(button);
            });
            
            chatContainer.appendChild(buttonGroup);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function askQuestion() {
            if (conversationState.step >= questions.length) {
                showSummary();
                return;
            }

            const currentQuestion = questions[conversationState.step];
            
            setTimeout(() => {
                hideTyping();
                addMessage(currentQuestion.question);
                
                if (currentQuestion.help) {
                    const help = document.createElement('div');
                    help.className = 'message bot-message location-help';
                    help.textContent = currentQuestion.help;
                    chatContainer.appendChild(help);
                }
                
                if (currentQuestion.options) {
                    addButtons(currentQuestion.options);
                }
                
                if (currentQuestion.optional) {
                    addButtons(['Skip']);
                }
            }, 800);
        }

        function handleUserResponse(response) {
            const buttonGroups = chatContainer.querySelectorAll('.button-group');
            buttonGroups.forEach(bg => bg.remove());

            addMessage(response, true);
            
            const currentQuestion = questions[conversationState.step];
            
            if (response !== 'Skip') {
                conversationState.data[currentQuestion.key] = response;
            }
            
            conversationState.step++;
            showTyping();
            askQuestion();
        }

        function showSummary() {
            hideTyping();
            
            setTimeout(() => {
                addMessage("Perfect! Here's what you reported:");
                
                setTimeout(() => {
                    let summary = `ðŸ“ Location: ${conversationState.data.location}\n`;
                    summary += `â›º Tents: ${conversationState.data.tentCount || 'Not specified'}\n`;
                    summary += `ðŸš— Vehicles: ${conversationState.data.vehicles || 'Not specified'}\n`;
                    summary += `ðŸ“… Timeline: ${conversationState.data.timeline || 'Not specified'}`;
                    
                    if (conversationState.data.description) {
                        summary += `\nðŸ’¬ Notes: ${conversationState.data.description}`;
                    }
                    
                    addMessage(summary);
                    
                    setTimeout(() => {
                        addMessage("I'll now open your email app with everything pre-filled. Just review and hit send!");
                        
                        const submitButton = document.createElement('button');
                        submitButton.className = 'submit-form-button';
                        submitButton.textContent = 'ðŸ“§ Open Email to Submit';
                        submitButton.onclick = submitToPortland;
                        chatContainer.appendChild(submitButton);
                        
                        const restartButton = document.createElement('button');
                        restartButton.className = 'restart-button';
                        restartButton.textContent = 'â†» Report Another Campsite';
                        restartButton.onclick = restartConversation;
                        chatContainer.appendChild(restartButton);
                        
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 1000);
                }, 1000);
            }, 500);
        }

        function submitToPortland() {
            const data = conversationState.data;
            
            // Build email subject
            const subject = encodeURIComponent('Campsite Report - ' + data.location);
            
            // Build email body with all details
            let body = 'I would like to report a campsite at the following location:\n\n';
            body += `Location: ${data.location}\n\n`;
            
            if (data.tentCount) {
                body += `Number of tents/structures: ${data.tentCount}\n`;
            }
            if (data.vehicles) {
                body += `Vehicles present: ${data.vehicles}\n`;
            }
            if (data.timeline) {
                body += `First noticed: ${data.timeline}\n`;
            }
            if (data.description) {
                body += `\nAdditional details:\n${data.description}\n`;
            }
            
            body += '\n---\nSubmitted via PDX Campsite Reporter';
            
            // Encode the body for mailto link
            const encodedBody = encodeURIComponent(body);
            
            // Create mailto link to Portland's reporting email
            const mailtoLink = `mailto:reportpdx@portlandoregon.gov?subject=${subject}&body=${encodedBody}`;
            
            // Open email client
            window.location.href = mailtoLink;
        }

        function restartConversation() {
            chatContainer.innerHTML = '<div class="message bot-message">Hi! I\'ll help you report a campsite to the City of Portland. This will take about 60 seconds. Ready to start?</div>';
            conversationState = {
                step: 0,
                data: {
                    location: '',
                    tentCount: '',
                    vehicles: '',
                    description: '',
                    timeline: '',
                    contact: ''
                }
            };
            userInput.value = '';
            setTimeout(() => {
                showTyping();
                askQuestion();
            }, 1000);
        }

        sendButton.addEventListener('click', () => {
            const response = userInput.value.trim();
            if (response) {
                handleUserResponse(response);
                userInput.value = '';
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        let recognition = null;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                voiceButton.classList.add('recording');
                console.log('Voice recognition started');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                voiceButton.classList.remove('recording');
                console.log('Transcript:', transcript);
            };

            recognition.onerror = (event) => {
                voiceButton.classList.remove('recording');
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please enable microphone permissions in your browser settings.');
                } else if (event.error === 'no-speech') {
                    alert('No speech detected. Please try again.');
                }
            };

            recognition.onend = () => {
                voiceButton.classList.remove('recording');
                console.log('Voice recognition ended');
            };

            voiceButton.addEventListener('click', () => {
                if (voiceButton.classList.contains('recording')) {
                    recognition.stop();
                } else {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Error starting recognition:', error);
                        alert('Unable to start voice input. Make sure you\'re using HTTPS and have granted microphone permissions.');
                    }
                }
            });
        } else {
            voiceButton.style.display = 'none';
            console.log('Speech recognition not supported in this browser');
        }

        setTimeout(() => {
            showTyping();
            askQuestion();
        }, 1000);
    </script>
</body>
</html>
