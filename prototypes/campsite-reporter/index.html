<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>PDX Campsite Reporter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: #1a472a;
            color: white;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .user-message {
            background: #1a472a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .input-area {
            background: white;
            padding: 12px;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            border-top: 1px solid #ddd;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-area input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
        }

        .input-area input:focus {
            border-color: #1a472a;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .quick-button {
            background: #1a472a;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .quick-button:active {
            background: #143820;
        }

        .send-button {
            background: #1a472a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
        }

        .send-button:active {
            background: #143820;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 60px;
            align-self: flex-start;
            position: absolute;
            bottom: 80px;
            left: 20px;
        }

        .typing-indicator.active {
            display: block;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .submit-form-button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }

        .location-help {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .restart-button {
            background: #f0f0f0;
            color: #666;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        PDX Campsite Reporter
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            Hi! I'll help you report a campsite to the City of Portland. This will take about 60 seconds. Ready to start?
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Type your answer..." />
        <button class="send-button" id="sendButton">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');

        let conversationState = {
            step: 0,
            data: {
                location: '',
                tentCount: '',
                vehicles: '',
                description: '',
                timeline: '',
                contact: '',
                blockingAccess: '',
                siteItems: [],
                vehicleDetails: {},
                needsPhotos: false,
                privateProperty: ''
            }
        };

        const vehicleTypes = ['2 Door', '4 Door', '5th Wheel', 'Boat', 'Boat on Trailer', 'Boat Trailer', 'Box Truck', 'Bus', 'Camper', 'Canopy', 'Cargo Trailer', 'Dropbox', 'Dumpster', 'Flatbed Trailer', 'Golf Cart', 'Motorcycle', 'Motorhome', 'Pickup', 'Pickup Camper', 'Pickup with Trailer', 'Pod', 'Semi Cab', 'Semi Trailer', 'Station Wagon', 'Step Van', 'Storage Container', 'SUV', 'Tow Truck', 'Tractor Trailer', 'Trailer', 'Travel Trailer', 'Truck', 'Utility Trailer', 'Van'];
        
        const vehicleMakes = ['Acura', 'Alfa', 'American', 'Aprilia', 'Assembled', 'Astin Martin', 'Audi', 'Bajaj', 'Bentley', 'BMW', 'Buell', 'Buick', 'Cadillac', 'Chevrolet', 'Chrysler', 'Citroen', 'Daewoo', 'Daihatsu', 'Datsun', 'Desoto', 'Dodge', 'Ducati', 'Eagle', 'Ferrari', 'Fiat', 'Ford', 'Freightliner', 'Freuhaf', 'Genuine', 'Geo', 'GMC', 'Great Dane', 'Grumman', 'Harley Davidson', 'Hino', 'Honda', 'Hudson', 'Hummer', 'Hyundai', 'Indian', 'Infiniti', 'International', 'Isuzu', 'Italjet', 'Jaguar', 'Jeep', 'Jensen', 'Kawasaki', 'Kenworth', 'Kia', 'Kymco', 'Lamborghini', 'Lancia', 'Land Rover', 'Lexus', 'Lincoln', 'Lotus', 'Mack Truck', 'Maserati', 'Mazda', 'Mercedes Benz', 'Mercury', 'Merker', 'MG', 'Mini', 'Mitsubishi', 'Moto Guzzi', 'Nash', 'Nissan', 'Oldsmobile', 'Opel', 'Packard', 'Panoz', 'Peterbilt', 'Peugeot', 'Piaggio', 'Plymouth', 'Pontiac', 'Porsche', 'Prevost', 'Rambler', 'Renault', 'Rolls Royce', 'Saab', 'Saturn', 'Scion', 'Smartcar', 'Sterling', 'Studebaker', 'Subaru', 'Sunbeam', 'Suzuki', 'Symco', 'Tesla', 'Think', 'Toyota', 'Triumph', 'U-D', 'Utilimaster', 'Vespa', 'Victory', 'Volkswagen', 'Volvo', 'Wabash', 'White', 'Wiggins', 'Willys', 'Winnebago', 'Yamaha', 'Yugo', 'Unknown / Not sure'];
        
        const vehicleColors = ['Beige', 'Black', 'Blue', 'Brown', 'Dark Blue', 'Gold', 'Green', 'Gray', 'Maroon', 'Orange', 'Pink', 'Purple', 'Red', 'Silver', 'Silver Blue', 'Tan', 'Teal', 'White', 'Yellow', 'Unidentifiable'];
        
        const states = ['OR (Oregon)', 'WA (Washington)', 'AL (Alabama)', 'AK (Alaska)', 'AZ (Arizona)', 'AR (Arkansas)', 'CA (California)', 'CO (Colorado)', 'CT (Connecticut)', 'DE (Delaware)', 'DC (District of Columbia)', 'FL (Florida)', 'GA (Georgia)', 'GU (Guam)', 'HI (Hawaii)', 'ID (Idaho)', 'IL (Illinois)', 'IN (Indiana)', 'IA (Iowa)', 'KS (Kansas)', 'KY (Kentucky)', 'LA (Louisiana)', 'ME (Maine)', 'MD (Maryland)', 'MA (Massachusetts)', 'MI (Michigan)', 'MN (Minnesota)', 'MS (Mississippi)', 'MO (Missouri)', 'MT (Montana)', 'NE (Nebraska)', 'NV (Nevada)', 'NH (New Hampshire)', 'NJ (New Jersey)', 'NM (New Mexico)', 'NY (New York)', 'NC (North Carolina)', 'ND (North Dakota)', 'OH (Ohio)', 'OK (Oklahoma)', 'PA (Pennsylvania)', 'RI (Rhode Island)', 'SC (South Carolina)', 'SD (South Dakota)', 'TN (Tennessee)', 'TX (Texas)', 'UT (Utah)', 'VT (Vermont)', 'VA (Virginia)', 'WV (West Virginia)', 'WI (Wisconsin)', 'WY (Wyoming)', 'Not sure'];

        const questions = [
            {
                question: "Where is the campsite located? (You can say the address, intersection, or nearby landmark)",
                key: 'location',
                help: "e.g., 'SE Hawthorne and 32nd' or '123 Main St'"
            },
            {
                question: "Is the campsite blocking pedestrian access, like a sidewalk, trail, or path?",
                key: 'blockingAccess',
                options: ['Yes', 'No']
            },
            {
                question: "Which of the following items are visible at the site? (Select all that apply)",
                key: 'siteItems',
                options: ['Tent, tarp, or other shelter', 'Vehicle (car, truck, RV, trailer, etc.)', 'Trash or debris only'],
                multiSelect: true
            },
            // Conditional questions will be inserted dynamically based on siteItems
            {
                question: "Is the location on private property?",
                key: 'privateProperty',
                options: ['Yes', 'No', 'Not sure']
            },
            {
                question: "When did you first notice this campsite?",
                key: 'timeline',
                options: ['Today', 'This week', 'This month', 'Longer than a month']
            },
            {
                question: "Anything else you'd like to add? (optional - describe conditions, concerns, etc.)",
                key: 'description',
                optional: true
            },
            {
                question: "Would you like to provide your email for follow-up? (optional)",
                key: 'contact',
                optional: true
            }
        ];

        function addMessage(text, isUser = false) {
            const message = document.createElement('div');
            message.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            message.textContent = text;
            chatContainer.appendChild(message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            typingIndicator.classList.add('active');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.classList.remove('active');
        }

        function addButtons(options, multiSelect = false) {
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';
            
            if (multiSelect) {
                // Multi-select mode with checkboxes
                const selectedItems = [];
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'quick-button';
                    button.textContent = `☐ ${option}`;
                    button.dataset.selected = 'false';
                    button.onclick = () => {
                        if (button.dataset.selected === 'false') {
                            button.dataset.selected = 'true';
                            button.textContent = `☑ ${option}`;
                            button.style.background = '#0f3317';
                            selectedItems.push(option);
                        } else {
                            button.dataset.selected = 'false';
                            button.textContent = `☐ ${option}`;
                            button.style.background = '#1a472a';
                            const index = selectedItems.indexOf(option);
                            if (index > -1) selectedItems.splice(index, 1);
                        }
                    };
                    buttonGroup.appendChild(button);
                });
                
                // Add Continue button for multi-select
                const continueButton = document.createElement('button');
                continueButton.className = 'quick-button';
                continueButton.textContent = 'Continue';
                continueButton.style.background = '#ff6b35';
                continueButton.style.marginTop = '8px';
                continueButton.onclick = () => {
                    if (selectedItems.length > 0) {
                        handleUserResponse(selectedItems.join(', '));
                    } else {
                        alert('Please select at least one option');
                    }
                };
                buttonGroup.appendChild(continueButton);
            } else {
                // Single select mode
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'quick-button';
                    button.textContent = option;
                    button.onclick = () => handleUserResponse(option);
                    buttonGroup.appendChild(button);
                });
            }
            
            chatContainer.appendChild(buttonGroup);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function notePhotosNeeded(itemType) {
            conversationState.data.needsPhotos = true;
            setTimeout(() => {
                addMessage(`Great! Please take photos of the ${itemType} and have them ready to attach to the email.`);
                setTimeout(() => {
                    continueAfterPhotoNote();
                }, 1500);
            }, 800);
        }

        function continueAfterPhotoNote() {
            conversationState.step++;
            showTyping();
            askQuestion();
        }

        function askQuestion() {
            if (conversationState.step >= questions.length) {
                showSummary();
                return;
            }

            const currentQuestion = questions[conversationState.step];
            
            setTimeout(() => {
                hideTyping();
                addMessage(currentQuestion.question);
                
                if (currentQuestion.help) {
                    const help = document.createElement('div');
                    help.className = 'message bot-message location-help';
                    help.textContent = currentQuestion.help;
                    chatContainer.appendChild(help);
                }
                
                if (currentQuestion.options) {
                    addButtons(currentQuestion.options, currentQuestion.multiSelect);
                }
                
                if (currentQuestion.optional) {
                    addButtons(['Skip']);
                }
            }, 800);
        }

        function handleUserResponse(response) {
            // Remove any existing button groups and upload containers
            const buttonGroups = chatContainer.querySelectorAll('.button-group');
            buttonGroups.forEach(bg => bg.remove());
            
            const uploadContainers = chatContainer.querySelectorAll('[style*="marginTop"]');
            uploadContainers.forEach(uc => {
                if (uc.querySelector('input[type="file"]')) uc.remove();
            });

            addMessage(response, true);
            
            const currentQuestion = questions[conversationState.step];
            
            if (response !== 'Skip') {
                if (currentQuestion.multiSelect) {
                    conversationState.data[currentQuestion.key] = response.split(', ');
                } else {
                    conversationState.data[currentQuestion.key] = response;
                }
            }
            
            // Handle conditional photo uploads based on siteItems
            if (currentQuestion.key === 'siteItems') {
                const items = response.split(', ');
                
                if (items.includes('Tent, tarp, or other shelter')) {
                    conversationState.step++;
                    showTyping();
                    notePhotosNeeded('tent/shelter');
                    return;
                } else if (items.includes('Vehicle (car, truck, RV, trailer, etc.)')) {
                    conversationState.step++;
                    askVehicleQuestions();
                    return;
                } else if (items.includes('Trash or debris only')) {
                    conversationState.step++;
                    showTyping();
                    notePhotosNeeded('trash/debris');
                    return;
                }
            }
            
            conversationState.step++;
            showTyping();
            askQuestion();
        }

        let vehicleQuestionStep = 0;

        function askVehicleQuestions() {
            const vehicleQuestions = [
                {
                    question: "What type of vehicle?",
                    key: 'vehicleType',
                    options: vehicleTypes.slice(0, 10), // Show first 10, can type for others
                    allowText: true
                },
                {
                    question: "Vehicle make/brand? (Type or select)",
                    key: 'vehicleMake',
                    options: ['Ford', 'Chevrolet', 'Toyota', 'Honda', 'Nissan', 'Unknown / Not sure'],
                    allowText: true
                },
                {
                    question: "Vehicle color?",
                    key: 'vehicleColor',
                    options: vehicleColors.slice(0, 10)
                },
                {
                    question: "License plate state? (Type or select)",
                    key: 'plateState',
                    options: ['OR (Oregon)', 'WA (Washington)', 'CA (California)', 'Not sure'],
                    allowText: true
                },
                {
                    question: "License plate number? (Type it, or say 'Skip' if unknown)",
                    key: 'plateNumber',
                    optional: true
                }
            ];

            if (vehicleQuestionStep >= vehicleQuestions.length) {
                // Note that vehicle photos are needed
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    addMessage("Great! Please take photos of the vehicle and have them ready to attach to the email.");
                    conversationState.data.needsPhotos = true;
                    setTimeout(() => {
                        vehicleQuestionStep = 0;
                        conversationState.step++;
                        showTyping();
                        askQuestion();
                    }, 1500);
                }, 800);
                return;
            }

            const vq = vehicleQuestions[vehicleQuestionStep];
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                addMessage(vq.question);
                
                if (vq.options) {
                    addButtons(vq.options);
                }
                
                if (vq.optional) {
                    addButtons(['Skip']);
                }
            }, 800);

            // Listen for vehicle response
            const originalHandler = handleUserResponse;
            window.handleVehicleResponse = (resp) => {
                buttonGroups = chatContainer.querySelectorAll('.button-group');
                buttonGroups.forEach(bg => bg.remove());
                
                addMessage(resp, true);
                
                if (resp !== 'Skip') {
                    if (!conversationState.data.vehicleDetails) {
                        conversationState.data.vehicleDetails = {};
                    }
                    conversationState.data.vehicleDetails[vq.key] = resp;
                }
                
                vehicleQuestionStep++;
                askVehicleQuestions();
            };
            
            // Temporarily replace handler
            const buttons = chatContainer.querySelectorAll('.quick-button');
            buttons.forEach(btn => {
                const oldOnclick = btn.onclick;
                btn.onclick = () => window.handleVehicleResponse(btn.textContent);
            });
        }

        function showSummary() {
            hideTyping();
            
            setTimeout(() => {
                addMessage("Perfect! Here's what you reported:");
                
                setTimeout(() => {
                    let summary = `📍 Location: ${conversationState.data.location}\n`;
                    summary += `🚶 Blocking access: ${conversationState.data.blockingAccess || 'Not specified'}\n`;
                    
                    if (conversationState.data.siteItems && conversationState.data.siteItems.length > 0) {
                        summary += `📋 Items at site: ${conversationState.data.siteItems.join(', ')}\n`;
                    }
                    
                    if (conversationState.data.vehicleDetails && Object.keys(conversationState.data.vehicleDetails).length > 0) {
                        summary += `🚗 Vehicle: ${conversationState.data.vehicleDetails.vehicleType || ''} ${conversationState.data.vehicleDetails.vehicleMake || ''} (${conversationState.data.vehicleDetails.vehicleColor || ''})\n`;
                        if (conversationState.data.vehicleDetails.plateState) {
                            summary += `   Plate: ${conversationState.data.vehicleDetails.plateState} ${conversationState.data.vehicleDetails.plateNumber || ''}\n`;
                        }
                    }
                    
                    summary += `🏠 Private property: ${conversationState.data.privateProperty || 'Not specified'}\n`;
                    summary += `📅 First noticed: ${conversationState.data.timeline || 'Not specified'}`;
                    
                    if (conversationState.data.description) {
                        summary += `\n💬 Notes: ${conversationState.data.description}`;
                    }
                    
                    addMessage(summary);
                    
                    setTimeout(() => {
                        if (conversationState.data.needsPhotos) {
                            addMessage("📸 IMPORTANT: Don't forget to attach your photos to the email before sending!");
                        }
                        
                        setTimeout(() => {
                            addMessage("I'll now open your email app with everything pre-filled. Review the details and send!");
                            
                            const submitButton = document.createElement('button');
                            submitButton.className = 'submit-form-button';
                            submitButton.textContent = '📧 Open Email to Submit';
                            submitButton.onclick = submitToPortland;
                            chatContainer.appendChild(submitButton);
                            
                            const restartButton = document.createElement('button');
                            restartButton.className = 'restart-button';
                            restartButton.textContent = '↻ Report Another Campsite';
                            restartButton.onclick = restartConversation;
                            chatContainer.appendChild(restartButton);
                            
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 500);
        }

        function submitToPortland() {
            const data = conversationState.data;
            
            // Build email subject
            const subject = encodeURIComponent('Campsite Report - ' + data.location);
            
            // Build email body with all details
            let body = 'I would like to report a campsite at the following location:\n\n';
            body += `Location: ${data.location}\n\n`;
            
            body += `Blocking Pedestrian Access: ${data.blockingAccess || 'Not specified'}\n\n`;
            
            if (data.siteItems && data.siteItems.length > 0) {
                body += `Items visible at site:\n`;
                data.siteItems.forEach(item => {
                    body += `- ${item}\n`;
                });
                body += '\n';
            }
            
            if (data.vehicleDetails && Object.keys(data.vehicleDetails).length > 0) {
                body += `Vehicle Details:\n`;
                if (data.vehicleDetails.vehicleType) body += `- Type: ${data.vehicleDetails.vehicleType}\n`;
                if (data.vehicleDetails.vehicleMake) body += `- Make: ${data.vehicleDetails.vehicleMake}\n`;
                if (data.vehicleDetails.vehicleColor) body += `- Color: ${data.vehicleDetails.vehicleColor}\n`;
                if (data.vehicleDetails.plateState) body += `- License Plate State: ${data.vehicleDetails.plateState}\n`;
                if (data.vehicleDetails.plateNumber) body += `- License Plate Number: ${data.vehicleDetails.plateNumber}\n`;
                body += '\n';
            }
            
            body += `Private Property: ${data.privateProperty || 'Not specified'}\n`;
            body += `First Noticed: ${data.timeline || 'Not specified'}\n\n`;
            
            if (data.description) {
                body += `Additional Details:\n${data.description}\n\n`;
            }
            
            if (data.needsPhotos) {
                body += `NOTE: Photos will be attached to this email.\n\n`;
            }
            
            if (data.contact && data.contact !== 'Skip') {
                body += `Contact Email: ${data.contact}\n\n`;
            }
            
            body += '---\nSubmitted via PDX Campsite Reporter';
            
            // Encode the body for mailto link
            const encodedBody = encodeURIComponent(body);
            
            // Create mailto link to Portland's reporting email
            const mailtoLink = `mailto:reportpdx@portlandoregon.gov?subject=${subject}&body=${encodedBody}`;
            
            // Open email client
            window.location.href = mailtoLink;
        }

        function restartConversation() {
            chatContainer.innerHTML = '<div class="message bot-message">Hi! I\'ll help you report a campsite to the City of Portland. This will take about 60 seconds. Ready to start?</div>';
            conversationState = {
                step: 0,
                data: {
                    location: '',
                    tentCount: '',
                    vehicles: '',
                    description: '',
                    timeline: '',
                    contact: '',
                    blockingAccess: '',
                    siteItems: [],
                    vehicleDetails: {},
                    needsPhotos: false,
                    privateProperty: ''
                }
            };
            vehicleQuestionStep = 0;
            userInput.value = '';
            setTimeout(() => {
                showTyping();
                askQuestion();
            }, 1000);
        }

        sendButton.addEventListener('click', () => {
            const response = userInput.value.trim();
            if (response) {
                handleUserResponse(response);
                userInput.value = '';
            }
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });

        setTimeout(() => {
            showTyping();
            askQuestion();
        }, 1000);
    </script>
</body>
</html>
